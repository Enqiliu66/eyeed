
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="version" content="1.0.2"> <!-- 添加版本号 -->
  <title>进食障碍眼动干预程序</title>

  <!-- 引入 Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <!-- jsPsych 相关脚本（本地化版本） -->
  <script src="./webgazer.js"></script>
  <script src="./lib/jspsych@8.0.0.js"></script>
  <script src="./lib/plugin-preload@2.0.0.js"></script>
  <script src="./lib/plugin-html-button-response@2.0.0.js"></script>
  <script src="./lib/plugin-html-keyboard-response@2.0.0.js"></script>
  <script src="./lib/plugin-image-keyboard-response@2.0.0.js"></script>
  <script src="./lib/plugin-audio-keyboard-response@2.0.0.js"></script>
  <script src="./lib/plugin-webgazer-init-camera@2.0.0.js"></script>
  <script src="./lib/plugin-webgazer-calibrate@2.0.0.js"></script>
  <script src="./lib/plugin-webgazer-validate@2.0.0.js"></script>
  <script src="./lib/extension-webgazer@1.0.3.js"></script>
  <script src="./lib/plugin-call-function@1.0.0.js"></script>

  <!-- 引入FileSaver.js用于保存文件（本地化版本） -->
  <script src="./lib/FileSaver.min@2.0.5.js"></script>

  <style>
    /* ==== 全局样式 ==== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      font-family: 'Roboto', 'Microsoft YaHei', sans-serif;
      background: #f5f6f8;
      color: #333;
      overflow: hidden;
    }

    /* ==== 顶部导航栏 ==== */
    .header {
      width: 100%;
      background: linear-gradient(90deg, #2c3e50, #4b6082);
      padding: 15px 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
      display: flex;
      justify-content: center;
    }
    .header h1 {
      color: #fff;
      font-weight: 500;
      font-size: 1.6rem;
      letter-spacing: 1px;
    }

    /* ==== 内容容器 ==== */
    #jspsych-target {
      position: absolute;
      top: 70px;
      left: 0;
      width: 100%;
      height: calc(100vh - 70px);
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f6f8;
    }
    #jspsych-target .jspsych-display-element {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f6f8;
    }
    #jspsych-target .jspsych-content {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      max-height: 100%;
    }

        /* ==== 离线提示样式 ==== */
    .offline-alert {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #e74c3c;
      color: white;
      padding: 10px;
      text-align: center;
      z-index: 10000;
      font-weight: bold;
    }


    /* ==== 食物展示区 - 2x2网格 ==== */
    .food-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 20px;
      width: 80%;
      height: 70vh;
      margin: 0 auto;
      padding: 20px;
      border-radius: 20px;
      background: #ffffff;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
    }
    .food-item {
      width: 100%;
      height: 100%;
      position: relative;
      border-radius: 20px;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      background-color: #fafafa;
      cursor: pointer;
    }
    .food-item:hover {
      transform: translateY(-5px) scale(1.03);
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.15);
    }
    .food-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    /* ==== 中央固定十字 ==== */
    .central-fixation {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 80px;
      color: #555;
      -webkit-user-select: none;
      user-select: none;
      z-index: 999;
      display: none;
    }

    /* ==== 眼动追踪注视点（已禁用） ==== */
    .gaze-point {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: red;
      border-radius: 50%;
      pointer-events: none;
      z-index: 9999;
      display: none !important; /* 确保小红点被隐藏 */
    }

    /* ==== 音乐指示条 ==== */
    .music-indicator {
      position: fixed;
      top: 90px;
      right: 30px;
      background: linear-gradient(90deg, #1abc9c, #16a085);
      color: #fff;
      padding: 12px 28px;
      border-radius: 30px;
      font-weight: 500;
      font-size: 1rem;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1001;
    }

    /* ==== 按钮样式 ==== */
    button {
      background: linear-gradient(90deg, #2980b9, #3498db);
      border: none;
      color: #fff;
      padding: 14px 36px;
      text-align: center;
      font-size: 1rem;
      margin: 6px;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    button:hover {
      background: linear-gradient(90deg, #2572a5, #2c82c2);
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    }

    .jspsych-html-button-response .jspsych-button-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    /* ==== 居中文字模块 ==== */
    .centered-text {
      text-align: center;
      padding: 20px 30px;
      color: #444;
      line-height: 1.6;
      max-width: 800px;
    }
    .centered-text p {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    /* ==== 页脚 ==== */
    .footer {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      color: #888;
      font-size: 0.9rem;
      letter-spacing: 0.5px;
    }

    /* ==== 登录表单样式 ==== */
    .login-container {
      width: 700px;
      background: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
      text-align: center;
      margin: 0 auto;
    }
    .login-container h2 {
      color: #2c3e50;
      margin-bottom: 25px;
      font-weight: 500;
    }
    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    .form-group input:focus, .form-group select:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    .login-button {
      background: linear-gradient(90deg, #2980b9, #3498db);
      border: none;
      color: #fff;
      padding: 14px 36px;
      text-align: center;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      width: 100%;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .login-button:hover {
      background: linear-gradient(90deg, #2572a5, #2c82c2);
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    }

    /* 新增：实验天数显示样式 */
    .day-display {
      background: #f0f7ff;
      border-radius: 12px;
      padding: 15px;
      margin: 20px 0;
      border: 2px solid #d0e4ff;
      font-size: 1.3rem;
      font-weight: 500;
    }
    .day-display span {
      color: #2980b9;
      font-weight: 600;
    }

    /* 新增：功能选择按钮 */
    .function-select-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 30px;
    }
    .function-button {
      padding: 20px 40px;
      font-size: 1.2rem;
      border-radius: 12px;
      border: none;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
    }
    .experiment-button {
      background: linear-gradient(90deg, #2980b9, #3498db);
    }
    .questionnaire-button {
      background: linear-gradient(90deg, #27ae60, #2ecc71);
    }
    .function-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    /* ==== 数据报告样式 ==== */
    .data-report {
      max-width: 800px;
      background: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
      text-align: left;
      font-family: 'Courier New', monospace;
      max-height: 80vh;
      overflow-y: auto;
    }
    .data-report h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 500;
    }
    .data-report pre {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    .copy-button {
      background: linear-gradient(90deg, #27ae60, #2ecc71);
      border: none;
      color: #fff;
      padding: 12px 28px;
      text-align: center;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      margin-top: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .copy-button:hover {
      background: linear-gradient(90deg, #219653, #27ad60);
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    }
    .github-button {
      background: linear-gradient(90deg, #24292e, #2d3338);
      border: none;
      color: #fff;
      padding: 12px 28px;
      text-align: center;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      margin-top: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .github-button:hover {
      background: linear-gradient(90deg, #1a1e21, #22272b);
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    }
    /* 新增：保存按钮样式 */
    .save-button {
      background: linear-gradient(90deg, #f39c12, #e67e22);
      border: none;
      color: #fff;
      padding: 12px 28px;
      text-align: center;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      margin-top: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .save-button:hover {
      background: linear-gradient(90deg, #d35400, #e67e22);
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    }

    /* 退出按钮 */
    .exit-button {
      background: linear-gradient(90deg, #e74c3c, #c0392b);
      border: none;
      color: #fff;
      padding: 12px 28px;
      text-align: center;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      margin-top: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .exit-button:hover {
      background: linear-gradient(90deg, #c0392b, #a93226);
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    }

    /* ==== 状态消息 ==== */
    .status-message {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
    }
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status-loading {
      background: #cce5ff;
      color: #004085;
      border: 1px solid #b8daff;
    }
    .status-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }

    /* 验证码弹窗 */
    .auth-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 3000;
      justify-content: center;
      align-items: center;
    }
    .auth-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      width: 400px;
      max-width: 90%;
      box-shadow: 0 15px 30px rgba(0,0,0,0.3);
    }
    .auth-content h3 {
      margin-bottom: 20px;
      color: #2c3e50;
    }
    .auth-input {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }
    .auth-buttons {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    .auth-button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s;
    }
    .auth-confirm {
      background: #27ae60;
      color: white;
    }
    .auth-confirm:hover {
      background: #219653;
    }
    .auth-cancel {
      background: #e74c3c;
      color: white;
    }
    .auth-cancel:hover {
      background: #c0392b;
    }
    .auth-error {
      color: #e74c3c;
      margin-top: 10px;
      display: none;
    }

    /* ==== 权限提示和错误提示样式 ==== */
    .permission-alert {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      z-index: 2000;
      max-width: 90%;
      width: 500px;
      display: none;
    }

    .permission-alert h3 {
      color: #e74c3c;
      margin-bottom: 20px;
    }

    .permission-alert p {
      margin: 10px 0;
      line-height: 1.6;
    }

    .permission-alert .warning {
      color: #e74c3c;
      font-weight: bold;
    }

    .permission-alert .browser-warning {
      background: #f8d7da;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: left;
    }

    .permission-alert .protocol-warning {
      background: #fff3cd;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: left;
    }

    /* ==== 初始化状态面板 ==== */
    .init-status-panel {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 15px;
      border-radius: 8px;
      max-width: 400px;
      z-index: 2000;
      font-size: 14px;
      display: none;
    }

    .init-status-panel h4 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #3498db;
      border-bottom: 1px solid #3498db;
      padding-bottom: 5px;
    }

    .init-status-panel .status-item {
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
    }

    .init-status-panel .status-label {
      font-weight: bold;
      margin-right: 10px;
    }

    .init-status-panel .status-value {
      color: #2ecc71;
    }

    .init-status-panel .status-error {
      color: #e74c3c;
    }

    .init-status-panel .status-warning {
      color: #f39c12;
    }

    .debug-toggle {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #3498db;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      z-index: 2001;
    }

    /* ==== 错误处理面板 ==== */
    .error-panel {
      background: #f8d7da;
      border-left: 4px solid #e74c3c;
      padding: 15px;
      margin: 20px 0;
      border-radius: 0 8px 8px 0;
      text-align: left;
    }

    .error-panel h4 {
      color: #721c24;
      margin-top: 0;
      margin-bottom: 10px;
    }

    .error-panel ul {
      padding-left: 20px;
      margin-bottom: 10px;
    }

    .error-panel li {
      margin-bottom: 5px;
    }

    /* ==== 问卷弹窗样式 ==== */
    .questionnaire-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      z-index: 2500;
      justify-content: center;
      align-items: center;
    }
    .questionnaire-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      position: relative;
    }
    .questionnaire-close {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
      color: #777;
      transition: color 0.3s;
    }
    .questionnaire-close:hover {
      color: #e74c3c;
    }
    .questionnaire-title {
      text-align: center;
      margin-bottom: 25px;
      color: #2c3e50;
      font-size: 1.8rem;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    .question-section {
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    .question-section-title {
      font-size: 1.4rem;
      color: #2980b9;
      margin-bottom: 15px;
    }
    .question-item {
      margin-bottom: 20px;
    }
    .question-item h4 {
      font-size: 1.1rem;
      margin-bottom: 10px;
      color: #333;
    }
    .options-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .option-item {
      padding: 8px 15px;
      background: #f1f8ff;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .option-item.selected {
      background: #3498db;
      color: white;
    }
    .option-item:hover {
      background: #d6eaf8;
    }
    .option-item.selected:hover {
      background: #2980b9;
    }
    .slider-container {
      width: 100%;
      padding: 10px 0;
    }
    .slider-container input[type="range"] {
      width: 100%;
      height: 10px;
      -webkit-appearance: none;
      background: #e0e7ff;
      border-radius: 5px;
      outline: none;
    }
    .slider-container input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: #3498db;
      border-radius: 50%;
      cursor: pointer;
    }
    .slider-labels {
      display: flex;
      justify-content: space-between;
      width: 100%;
      margin-top: 5px;
      font-size: 0.9rem;
      color: #666;
    }
    .text-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      resize: vertical;
      min-height: 100px;
    }
    .text-input:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    .questionnaire-buttons {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      gap: 15px;
    }
    .questionnaire-error {
      color: #e74c3c;
      margin-top: 10px;
      text-align: center;
      display: none;
    }
    .reflection-invitation {
      text-align: center;
      color: #777;
      font-size: 1.2rem;
      margin-top: 30px;
    }

    /* 新增：问卷成功提示 */
    .questionnaire-success {
      color: #27ae60;
      margin-top: 10px;
      text-align: center;
      display: none;
    }

    /* ==== 新添加的按钮容器样式 ==== */
    .reflection-button-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
      flex-wrap: wrap;
    }
    .reflection-button {
      min-width: 250px;
      padding: 18px 30px;
      font-size: 1.1rem;
      font-weight: 500;
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
    }
    .questionnaire-button {
      background: linear-gradient(90deg, #27ae60, #2ecc71);
    }
    .questionnaire-button:hover {
      background: linear-gradient(90deg, #219653, #27ad60);
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }
    .skip-button {
      background: linear-gradient(90deg, #3498db, #2980b9);
    }
    .skip-button:hover {
      background: linear-gradient(90deg, #2980b9, #2573a5);
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    /* 新增：关闭提示 */
    .close-hint {
      color: #888;
      font-size: 0.9rem;
      text-align: center;
      margin-top: 15px;
      font-style: italic;
    }

    /* 新增：调整提示文本样式 */
    .adjustment-hint {
      font-size: 0.9rem;
      color: #888;
      margin-top: 5px;
      font-style: italic;
    }
  </style>
</head>

<body>

  <!-- 离线状态提示 -->
  <div class="offline-alert" id="offline-alert" style="display:none;">
    网络连接已断开，正在使用离线模式
  </div>


  <!-- 顶部导航栏 -->
  <div class="header">
    <h1>进食障碍眼动干预实验</h1>
  </div>

  <!-- 音乐播放指示 -->
  <div class="music-indicator" id="music-indicator">音乐播放中</div>

  <!-- 中央固定十字 -->
  <div id="central-fixation" class="central-fixation">+</div>

  <!-- 眼动追踪注视点（已禁用） -->
  <div id="gaze-point" class="gaze-point"></div>

  <!-- 验证码弹窗 -->
  <div class="auth-modal" id="auth-modal">
    <div class="auth-content">
      <h3>请输入验证码以查看GitHub记录</h3>
      <input type="text" class="auth-input" id="auth-code" placeholder="输入验证码" />
      <div class="auth-error" id="auth-error">验证码错误，无权限查看</div>
      <div class="auth-buttons">
        <button class="auth-button auth-cancel" id="auth-cancel">返回</button>
        <button class="auth-button auth-confirm" id="auth-confirm">确认</button>
      </div>
    </div>
  </div>

  <!-- 摄像头权限提示 -->
  <div id="camera-permission-alert" class="permission-alert" style="display:none;"></div>

  <!-- 初始化状态面板 -->
  <div class="init-status-panel" id="init-status-panel">
    <h4>眼动追踪初始化状态</h4>
    <div class="status-item">
      <span class="status-label">摄像头状态:</span>
      <span class="status-value" id="status-camera">检测中...</span>
    </div>
    <div class="status-item">
      <span class="status-label">Webgazer状态:</span>
      <span class="status-value" id="status-webgazer">未初始化</span>
    </div>
    <div class="status-item">
      <span class="status-label">权限状态:</span>
      <span class="status-value" id="status-permission">未知</span>
    </div>
    <div class="status-item">
      <span class="status-label">安全环境:</span>
      <span class="status-value" id="status-security">检测中...</span>
    </div>
    <div class="status-item">
      <span class="status-label">错误信息:</span>
      <span class="status-value" id="status-error">无</span>
    </div>
  </div>

  <button class="debug-toggle" id="debug-toggle">显示调试信息</button>

  <!-- 问卷弹窗 -->
  <div class="questionnaire-modal" id="questionnaire-modal">
    <div class="questionnaire-content">
      <div class="questionnaire-close" id="questionnaire-close">×</div>
      <h2 class="questionnaire-title">第<span id="questionnaire-week">1</span>次周反思总结</h2>

      <div class="question-section">
        <h3 class="question-section-title">一、情绪状态记录</h3>

        <div class="question-item">
          <h4>1. 过去7天，您的整体情绪波动强度如何？</h4>
          <div class="slider-container">
            <input type="range" min="0" max="10" value="5" id="emotion-intensity">
            <div class="slider-labels">
              <span>0（非常平静）</span>
              <span>10（极度波动）</span>
            </div>
          </div>
        </div>

        <div class="question-item">
          <h4>2. 过去一周，您最常体验的三种情绪是？</h4>
          <div class="options-container" id="emotion-options">
            <div class="option-item" data-value="焦虑">焦虑</div>
            <div class="option-item" data-value="沮丧">沮丧</div>
            <div class="option-item" data-value="平静">平静</div>
            <div class="option-item" data-value="愉悦">愉悦</div>
            <div class="option-item" data-value="麻木">麻木</div>
            <div class="option-item" data-value="愤怒">愤怒</div>
            <div class="option-item" data-value="愧疚">愧疚</div>
          </div>
          <div id="selected-emotions" style="margin-top:10px;font-style:italic;color:#555;"></div>
        </div>
      </div>

      <div class="question-section">
        <h3 class="question-section-title">二、饮食行为评估</h3>

        <div class="question-item">
          <h4>1. 过去7天，您出现"无法停止进食或进食后强烈懊悔"的次数？</h4>
          <div class="options-container" id="eating-regret-options">
            <div class="option-item" data-value="0次">0次</div>
            <div class="option-item" data-value="1-2次">1-2次</div>
            <div class="option-item" data-value="3-4次">3-4次</div>
            <div class="option-item" data-value="≥5次">≥5次</div>
          </div>
        </div>

        <div class="question-item">
          <h4>2. 您刻意跳过正餐或极端控制热量的天数为？</h4>
          <div class="options-container" id="skip-meals-options">
            <div class="option-item" data-value="0天">0天</div>
            <div class="option-item" data-value="1-2天">1-2天</div>
            <div class="option-item" data-value="3-5天">3-5天</div>
            <div class="option-item" data-value="6-7天">6-7天</div>
          </div>
        </div>

        <div class="question-item">
          <h4>3. 您因体型/体重感到痛苦的频率？</h4>
          <div class="options-container" id="body-pain-options">
            <div class="option-item" data-value="从未">从未</div>
            <div class="option-item" data-value="偶尔">偶尔</div>
            <div class="option-item" data-value="经常">经常</div>
            <div class="option-item" data-value="总是">总是</div>
          </div>
        </div>
      </div>

      <div class="question-section">
        <h3 class="question-section-title">三、音乐干预反馈</h3>

        <div class="question-item">
          <h4>1. 您完成音乐眼动训练的天数？</h4>
          <div class="options-container" id="training-days-options">
            <div class="option-item" data-value="0天">0天</div>
            <div class="option-item" data-value="1-3天">1-3天</div>
            <div class="option-item" data-value="4-6天">4-6天</div>
            <div class="option-item" data-value="7天">7天</div>
          </div>
        </div>

        <div class="question-item">
          <h4>2. 音乐训练后，您在进食时的焦虑程度变化？</h4>
          <div class="slider-container">
            <input type="range" min="1" max="7" value="4" id="anxiety-change">
            <div class="slider-labels">
              <span>1（显著加剧）</span>
              <span style="position: absolute; left: 50%; transform: translateX(-50%);">4（无变化）</span>
              <span>7（显著缓解）</span>
            </div>
          </div>
        </div>
      </div>

      <div class="question-section">
        <h3 class="question-section-title">四、关键事件记录</h3>

        <div class="question-item">
          <h4>过去一周是否有事件(如社交压力、情绪冲击)显著影响您的情绪或进食？请简述：</h4>
          <textarea class="text-input" id="key-events" placeholder="请描述具体事件（限300字）..." maxlength="300"></textarea>
          <div style="text-align:right;font-size:0.8rem;color:#777;">
            <span id="char-count">0</span>/300 字符
          </div>
        </div>
      </div>

      <div class="questionnaire-error" id="questionnaire-error">
        请完成所有问题后再提交
      </div>

      <!-- 新增：问卷成功提示 -->
      <div class="questionnaire-success" id="questionnaire-success">
        问卷提交成功！
      </div>

      <div class="questionnaire-buttons" id="submit-buttons">
        <button class="login-button" id="submit-questionnaire">提交问卷</button>
      </div>

      <!-- 新增：关闭提示 -->
      <div class="close-hint">
        问卷完成后，点击右上角关闭按钮返回主界面
      </div>
    </div>
  </div>

  <!-- jsPsych 渲染目标容器 -->
  <div id="jspsych-target"></div>

  <!-- 页脚 -->
  <div class="footer">2025 北京师范大学 Eye—ED 项目组联合出品。</div>

<!-- Service Worker 注册 -->
  <script>
    // 注册Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        // 获取当前版本号
        const versionMeta = document.querySelector('meta[name="version"]');
        const version = versionMeta ? versionMeta.getAttribute('content') : '1.0.0';

        navigator.serviceWorker.register('/sw.js?v=' + version)
          .then(function(registration) {
            console.log('ServiceWorker 注册成功，作用域为: ', registration.scope);

            // 检查更新
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              console.log('发现Service Worker更新:', newWorker.state);

              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  console.log('新Service Worker已安装，准备激活');

                  // 显示更新提示
                  if (confirm('发现新版本，是否立即更新？')) {
                    // 发送消息给Service Worker，要求跳过等待
                    newWorker.postMessage({type: 'SKIP_WAITING'});
                  }
                }
              });
            });
          })
          .catch(function(error) {
            console.log('ServiceWorker 注册失败: ', error);
          });

        // 监听控制变化
        let refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (!refreshing) {
            refreshing = true;
            console.log('Controller 已变更，刷新页面以应用更新');
            window.location.reload();
          }
        });
      });
    }
  </script>

  <script>
    /* ==== 用户信息存储 ==== */
    let userInfo = null;
    let cameraPermissionDenied = false; // 摄像头权限状态
    let webgazerInitialized = false;   // Webgazer初始化状态

    /* ==== GitHub API 中转配置 ==== */
    const API_BASE_URL = 'https://www.edemi-lab.online/api/gh-eye';

    /* 初始化 jsPsych */
    const jsPsych = initJsPsych({
      display_element: 'jspsych-target',
      extensions: [
        { type: jsPsychExtensionWebgazer }
      ],
      on_finish: function() {
        // 实验结束时停止音乐
        if (window.globalAudio && !window.globalAudio.paused) {
          window.globalAudio.pause();
        }
      }
    });

    /* ==== 状态更新函数 ==== */
    function updateInitStatus(field, value, isError = false) {
      const element = document.getElementById(`status-${field}`);
      if (element) {
        element.textContent = value;
        element.className = isError ? 'status-error' : 'status-value';
      }
    }

    // 显示/隐藏调试信息
    document.getElementById('debug-toggle').addEventListener('click', function() {
      const panel = document.getElementById('init-status-panel');
      if (panel.style.display === 'block') {
        panel.style.display = 'none';
        this.textContent = '显示调试信息';
      } else {
        panel.style.display = 'block';
        this.textContent = '隐藏调试信息';
      }
    });

    // 在网络状态检测部分添加
    function updateOnlineStatus() {
      const offlineAlert = document.getElementById('offline-alert');
      const onlineAlert = document.getElementById('online-alert');

      if (!navigator.onLine) {
        offlineAlert.style.display = 'block';
        setTimeout(() => {
          offlineAlert.style.display = 'none';
        }, 3000);
      } else {
        onlineAlert.style.display = 'block';
        setTimeout(() => {
          onlineAlert.style.display = 'none';
        }, 3000);
      }
    }

    // 添加事件监听器
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);

    // 初始检查
    updateOnlineStatus();

    /* ==== 摄像头权限检测和错误处理函数 ==== */
    async function checkCameraPermission() {
      // 更新状态
      updateInitStatus('camera', '检测中...');
      updateInitStatus('permission', '检测中...');
      updateInitStatus('security', '检测中...');

      // 1. 检查是否在安全环境（HTTPS或localhost）
      const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
      updateInitStatus('security', isSecure ? '安全' : '不安全', !isSecure);

      // 2. 检查浏览器是否支持媒体设备
      const hasMediaDevices = 'mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices;
      updateInitStatus('camera', hasMediaDevices ? '支持' : '不支持', !hasMediaDevices);

      // 3. 尝试获取摄像头权限
      let hasPermission = false;
      try {
        if (hasMediaDevices) {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          hasPermission = true;
          // 关闭测试流
          stream.getTracks().forEach(track => track.stop());
        }
      } catch (error) {
        console.error('摄像头权限检测失败:', error);
        updateInitStatus('error', error.message || error.toString(), true);
      }

      updateInitStatus('permission', hasPermission ? '已授予' : '未授予', !hasPermission);

      return {
        hasPermission,
        isSecure,
        hasMediaDevices
      };
    }

    function showPermissionError(status) {
      const alertEl = document.getElementById('camera-permission-alert');

      let alertHTML = `
        <h3>摄像头权限问题</h3>
        ${!status.hasMediaDevices ? `
          <div class="browser-warning">
            <p class="warning">您的浏览器不支持摄像头功能</p>
            <p>请使用最新版本的Chrome、Firefox或Edge浏览器参与实验。</p>
          </div>
        ` : ''}

        ${!status.isSecure ? `
          <div class="protocol-warning">
            <p class="warning">当前环境不安全</p>
            <p>摄像头功能需要HTTPS安全连接或本地环境(localhost)。</p>
            <p>当前协议: ${location.protocol}</p>
          </div>
        ` : ''}

        ${status.hasMediaDevices && status.isSecure && !status.hasPermission ? `
          <p>实验需要使用您的摄像头进行眼动追踪。</p>
          <p>您尚未授予摄像头权限或权限已被拒绝。</p>
          <div class="instructions">
            <p class="warning">请按照以下步骤操作：</p>
            <ol>
              <li>点击浏览器地址栏左侧的摄像头图标</li>
              <li>选择"始终允许此网站使用摄像头"</li>
              <li>刷新页面</li>
            </ol>
          </div>
        ` : ''}

        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
          <button id="reload-btn" class="auth-confirm auth-button">刷新页面</button>
          <button id="continue-btn" class="auth-cancel auth-button">继续实验(无眼动)</button>
        </div>
      `;

      alertEl.innerHTML = alertHTML;
      alertEl.style.display = 'block';

      // 添加事件处理
      document.getElementById('reload-btn').addEventListener('click', () => {
        location.reload();
      });

      document.getElementById('continue-btn').addEventListener('click', function() {
        alertEl.style.display = 'none';
        // 设置标志允许实验继续（无眼动功能）
        cameraPermissionDenied = true;
        // 继续执行实验流程
        if (window.resumeExperiment) {
          window.resumeExperiment();
        }
      });
    }

    /* ==== GitHub API 功能 ==== */

    // 创建或获取Issue（带错误处理和重试机制） - 总共尝试2次
    async function getOrCreateIssue(retries = 1) {
      const issueTitle = `${userInfo.subjectId}`;

      try {
        // 使用AbortController实现超时
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const response = await fetch(API_BASE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'create_issue',
            subjectId: userInfo.subjectId,
            gender: userInfo.gender,
            age: userInfo.age
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          const errorData = await response.json();
          console.error('GitHub API错误详情:', errorData);
          throw new Error(`中转API返回错误: ${response.status}`);
        }

        return await response.json();
      } catch (error) {
        console.error(`GitHub Issue操作失败(剩余重试次数: ${retries-1}):`, error);

        // 如果还有重试次数，等待后重试
        if (retries > 0) {
          await new Promise(resolve => setTimeout(resolve, 2000));
          return getOrCreateIssue(retries - 1);
        }

        throw error;
      }
    }

    // 添加单条Issue评论 - 修改：重试次数改为1（即总共尝试2次）
    async function addIssueComment(issueNumber, commentBody, retries = 1) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const response = await fetch(API_BASE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'add_comment',
            issueNumber: issueNumber,
            commentBody: commentBody
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          const errorData = await response.json();
          console.error('添加评论错误详情:', errorData);
          throw new Error(`中转API返回错误: ${response.status}`);
        }

        return await response.json();
      } catch (error) {
        console.error(`添加评论失败(剩余重试次数: ${retries-1}):`, error);

        if (retries > 0) {
          await new Promise(resolve => setTimeout(resolve, 2000));
          return addIssueComment(issueNumber, commentBody, retries - 1);
        }

        throw error;
      }
    }

    // 上传CSV文件到GitHub仓库的data目录
    async function uploadCSVToGitHub(csvContent, fileName, retries = 1) {
      const MAX_FILE_SIZE = 700 * 1024; // 700KB
      const encoder = new TextEncoder();
      const csvData = encoder.encode(csvContent);
      const totalSize = csvData.length;

      try {
        // 如果文件小于最大限制，直接上传到data目录
        if (totalSize <= MAX_FILE_SIZE) {
          return await uploadFilePart(csvContent, `data/${fileName}`, retries);
        }

        // 分割文件
        let uploadPromises = [];
        let partIndex = 1;
        let startIndex = 0;

        while (startIndex < totalSize) {
          // 计算结束位置（尝试在换行符处分割）
          let endIndex = Math.min(startIndex + MAX_FILE_SIZE, totalSize);

          // 查找最近的换行符
          while (endIndex < totalSize && csvData[endIndex] !== 10) { // 10是换行符的ASCII
            endIndex++;
          }

          // 如果找不到换行符，使用最大位置
          if (endIndex >= totalSize) {
            endIndex = totalSize;
          }

          // 提取当前部分
          const partData = csvData.slice(startIndex, endIndex);
          const partContent = new TextDecoder().decode(partData);

          // 生成文件名（添加分块编号并放入data目录）
          const partFileName = `data/${fileName.replace('.csv', `_part${partIndex}.csv`)}`;

          // 上传分块
          uploadPromises.push(uploadFilePart(partContent, partFileName, retries));

          // 移动到下一部分
          startIndex = endIndex;
          partIndex++;
        }

        // 等待所有上传完成
        return await Promise.all(uploadPromises);
      } catch (error) {
        console.error(`CSV上传失败(剩余重试次数: ${retries-1}):`, error);

        if (retries > 0) {
          await new Promise(resolve => setTimeout(resolve, 2000));
          return uploadCSVToGitHub(csvContent, fileName, retries - 1);
        }

        throw error;
      }
    }

    // 上传单个文件分块到GitHub - 总共尝试2次
    async function uploadFilePart(content, fileName, retries = 1) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const response = await fetch(API_BASE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'upload_csv',
            fileName: fileName,
            content: content
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`文件上传失败: ${response.status}`);
        }

        return await response.json();
      } catch (error) {
        console.error(`文件分块上传失败(剩余重试次数: ${retries-1}):`, error);

        if (retries > 0) {
          await new Promise(resolve => setTimeout(resolve, 2000));
          return uploadFilePart(content, fileName, retries - 1);
        }

        throw error;
      }
    }

    // 生成GitHub评论内容（只包含数据点个数和实验时间）
    function generateGitHubComment(gazeData) {
      // 计算数据点总数
      const dataPoints = gazeData.reduce((acc, trial) => acc + trial.length, 0);

      // 获取当前日期时间
      const now = new Date();
      const dateTime = `${now.getFullYear()}年${(now.getMonth()+1).toString().padStart(2, '0')}月${now.getDate().toString().padStart(2, '0')}日 ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;

      return `## DAY-${userInfo.day} 实验数据\n\n` +
             `- **实验日期时间**: ${dateTime}\n` +
             `- **眼动数据点总数**: ${dataPoints}\n`;
    }

    // 生成CSV格式的眼动数据 - 修改：增加图片信息字段
    function generateCSVData(gazeData) {
      // 增加 image_type 和 image_id 字段
      let csvContent = "trial,timestamp,x,y,duration,image_type,image_id\n";

      gazeData.forEach((trialData, trialIndex) => {
        trialData.forEach(point => {
          // 提取图片类型和ID（如果存在）
          const imageType = point.imageInfo ? point.imageInfo.type : '';
          const imageId = point.imageInfo ? point.imageInfo.id : '';
          csvContent += `${trialIndex + 1},${point.timestamp},${point.x},${point.y},${point.duration},${imageType},${imageId}\n`;
        });
      });

      return csvContent;
    }

    // 保存CSV到本地
    function saveCSVToLocal(csvContent) {
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `eyetracking_data_${userInfo.subjectId}_DAY${userInfo.day}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    /* ==== 问卷相关函数 ==== */

    // 初始化问卷
    function initQuestionnaire() {
      // 设置问卷周次（使用实际问卷填写次数）
      document.getElementById('questionnaire-week').textContent = userInfo.weekCount;

      // 情绪多选处理
      const emotionOptions = document.querySelectorAll('#emotion-options .option-item');
      const selectedEmotions = [];

      emotionOptions.forEach(option => {
        option.addEventListener('click', function() {
          const value = this.getAttribute('data-value');

          if (this.classList.contains('selected')) {
            this.classList.remove('selected');
            const index = selectedEmotions.indexOf(value);
            if (index !== -1) selectedEmotions.splice(index, 1);
          } else {
            if (selectedEmotions.length < 3) {
              this.classList.add('selected');
              selectedEmotions.push(value);
            }
          }

          // 更新已选情绪显示
          document.getElementById('selected-emotions').textContent =
            selectedEmotions.length > 0 ?
            `已选: ${selectedEmotions.join(', ')}` :
            '';
        });
      });

      // 单选处理
      const singleOptionContainers = [
        '#eating-regret-options',
        '#skip-meals-options',
        '#body-pain-options',
        '#training-days-options'
      ];

      singleOptionContainers.forEach(selector => {
        const container = document.querySelector(selector);
        if (container) {
          const options = container.querySelectorAll('.option-item');
          options.forEach(option => {
            option.addEventListener('click', function() {
              // 清除同组其他选中
              options.forEach(opt => opt.classList.remove('selected'));
              // 选中当前
              this.classList.add('selected');
            });
          });
        }
      });

      // 文本输入字符计数
      document.getElementById('key-events').addEventListener('input', function() {
        document.getElementById('char-count').textContent = this.value.length;
      });

      // 关闭问卷按钮 - 修改：关闭后刷新页面
      document.getElementById('questionnaire-close').addEventListener('click', function() {
        document.getElementById('questionnaire-modal').style.display = 'none';
        location.reload(); // 刷新页面回到功能选择界面
      });
    }

    // 验证问卷是否完整
    function validateQuestionnaire() {
      // 1. 检查情绪多选题是否选了3个
      const emotionCount = document.querySelectorAll('#emotion-options .option-item.selected').length;
      if (emotionCount !== 3) {
        return false;
      }

      // 2. 检查所有单选题是否已选
      const singleChoiceSelectors = [
        '#eating-regret-options',
        '#skip-meals-options',
        '#body-pain-options',
        '#training-days-options'
      ];

      for (const selector of singleChoiceSelectors) {
        const container = document.querySelector(selector);
        if (container) {
          const selected = container.querySelector('.option-item.selected');
          if (!selected) {
            return false;
          }
        }
      }

      // 3. 检查关键事件记录是否为空或超过300字（修改点：将100改为300）
      const keyEvents = document.getElementById('key-events').value.trim();
      if (keyEvents.length === 0 || keyEvents.length > 300) {
        return false;
      }

      // 所有验证通过
      return true;
    }

    // 收集问卷数据
    function collectQuestionnaireData() {
      // 情绪多选题
      const selectedEmotions = Array.from(
        document.querySelectorAll('#emotion-options .option-item.selected')
      ).map(el => el.getAttribute('data-value'));

      // 饮食行为评估
      const eatingRegret = document.querySelector('#eating-regret-options .option-item.selected')?.getAttribute('data-value') || '';
      const skipMeals = document.querySelector('#skip-meals-options .option-item.selected')?.getAttribute('data-value') || '';
      const bodyPain = document.querySelector('#body-pain-options .option-item.selected')?.getAttribute('data-value') || '';

      // 音乐干预反馈
      const trainingDays = document.querySelector('#training-days-options .option-item.selected')?.getAttribute('data-value') || '';
      const anxietyChange = document.getElementById('anxiety-change').value;

      // 关键事件
      const keyEvents = document.getElementById('key-events').value;

      return {
        emotionIntensity: document.getElementById('emotion-intensity').value,
        selectedEmotions,
        eatingRegret,
        skipMeals,
        bodyPain,
        trainingDays,
        anxietyChange,
        keyEvents
      };
    }

    // 生成问卷结果的Markdown文本
    function generateQuestionnaireMarkdown(data) {
      const now = new Date();
      const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

      return `## 第${userInfo.weekCount}次周反思总结 (${dateStr})

### 一、情绪状态记录
1. **整体情绪波动强度**: ${data.emotionIntensity}/10
2. **最常体验的三种情绪**: ${data.selectedEmotions.join(', ')}

### 二、饮食行为评估
1. **无法停止进食或进食后懊悔次数**: ${data.eatingRegret}
2. **跳过正餐或极端控制热量天数**: ${data.skipMeals}
3. **因体型/体重感到痛苦的频率**: ${data.bodyPain}

### 三、音乐干预反馈
1. **完成音乐眼动训练天数**: ${data.trainingDays}
2. **进食时焦虑程度变化**: ${data.anxietyChange}/7 (1=显著加剧, 7=显著缓解)

### 四、关键事件记录
${data.keyEvents}
`;
    }

    // 保存问卷结果到Word文档
    function saveQuestionnaireToWord(data) {
      const markdownContent = generateQuestionnaireMarkdown(data);
      const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>周反思总结 - ${userInfo.subjectId} - 第${userInfo.weekCount}次</title>
          <style>
            body { font-family: 'Microsoft YaHei', sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px; }
            h1 { color: #2c3e50; text-align: center; }
            h2 { color: #2980b9; border-bottom: 1px solid #eee; padding-bottom: 5px; }
            h3 { color: #3498db; }
            .question { margin-bottom: 15px; }
            .answer { margin-left: 20px; margin-bottom: 20px; }
          </style>
        </head>
        <body>
          <h1>周反思总结</h1>
          <p><strong>被试ID</strong>: ${userInfo.subjectId}</p>
          <p><strong>周次</strong>: 第${userInfo.weekCount}次</p>
          <p><strong>提交日期</strong>: ${new Date().toLocaleString()}</p>

          <h2>一、情绪状态记录</h2>
          <div class="question">
            <h3>1. 过去7天，您的整体情绪波动强度如何？</h3>
            <div class="answer">${data.emotionIntensity}/10 (0=非常平静, 10=极度波动)</div>
          </div>

          <div class="question">
            <h3>2. 过去一周，您最常体验的三种情绪是？</h3>
            <div class="answer">${data.selectedEmotions.join(', ')}</div>
          </div>

          <h2>二、饮食行为评估</h2>
          <div class="question">
            <h3>1. 过去7天，您出现"无法停止进食或进食后强烈懊悔"的次数？</h3>
            <div class="answer">${data.eatingRegret}</div>
          </div>

          <div class="question">
            <h3>2. 您刻意跳过正餐或极端控制热量的天数为？</h3>
            <div class="answer">${data.skipMeals}</div>
          </div>

          <div class="question">
            <h3>3. 您因体型/体重感到痛苦的频率？</h3>
            <div class="answer">${data.bodyPain}</div>
          </div>

          <h2>三、音乐干预反馈</h2>
          <div class="question">
            <h3>1. 您完成音乐眼动训练的天数？</h3>
            <div class="answer">${data.trainingDays}</div>
          </div>

          <div class="question">
            <h3>2. 音乐训练后，您在进食时的焦虑程度变化？</h3>
            <div class="answer">${data.anxietyChange}/7 (1=显著加剧, 7=显著缓解)</div>
          </div>

          <h2>四、关键事件记录</h2>
          <div class="question">
            <h3>过去一周是否有事件(如社交压力、情绪冲击)显著影响您的情绪或进食？</h3>
            <div class="answer">${data.keyEvents.replace(/\n/g, '<br>')}</div>
          </div>
        </body>
        </html>
      `;

      const blob = new Blob([htmlContent], { type: 'application/msword' });
      saveAs(blob, `eye-${userInfo.subjectId.replace('EYE-', '')}-W${userInfo.weekCount}.doc`);
    }

    /* 生成图片列表 - 20张图片（001-020） */
    const lowCalorieImages = [];
    const highCalorieImages = [];
    const numImages = 20;

    for (let i = 1; i <= numImages; i++) {
      const idx = ('00' + i).slice(-3);
      lowCalorieImages.push('images/low/' + idx + '.jpg');
      highCalorieImages.push('images/high/' + idx + '.jpg');
    }

    /* 音乐文件列表 */
    const musicFiles = [
      'music/calm_music.mp3',
      'music/positive_sound.mp3'
    ];

    /* 初始化音乐播放器 */
    window.globalAudio = new Audio(musicFiles[0]);
    window.globalAudio.loop = true;

    /* ==== 用户登录页面 ==== */
    const loginScreen = {
      type: jsPsychHtmlButtonResponse,
      stimulus: function() {
        return `
          <div class="login-container">
            <h2>实验系统</h2>
            <p style="font-size: 1.2rem; margin-bottom: 30px; color: #555;">请选择您要进行的操作</p>

            <div class="function-select-container">
              <button class="function-button experiment-button" id="start-experiment">进入实验</button>
              <button class="function-button questionnaire-button" id="start-questionnaire">填写周反思总结</button>
            </div>
          </div>
        `;
      },
      choices: [],
      on_load: function() {
        // 进入实验按钮
        document.getElementById('start-experiment').addEventListener('click', function() {
          // 显示登录表单
          document.querySelector('.jspsych-content').innerHTML = `
            <div class="login-container">
              <h2>实验用户登录</h2>
              <div class="form-group">
                <label for="subject-id">被试ID</label>
                <select id="subject-id">
                  <option value="">请选择被试ID</option>
                  ${Array.from({length: 21}, (_, i) =>
                    `<option value="EYE-${(i+1).toString().padStart(3, '0')}">EYE-${(i+1).toString().padStart(3, '0')}</option>`
                  ).join('')}
                </select>
              </div>
              <div id="day-info"></div>
              <div class="form-group">
                <label for="gender">性别</label>
                <select id="gender">
                  <option value="">请选择性别</option>
                  <option value="男">男</option>
                  <option value="女">女</option>
                  <option value="其他">其他</option>
                </select>
              </div>
              <div class="form-group">
                <label for="age">年龄</label>
                <input type="number" id="age" min="18" max="60" placeholder="请输入年龄">
              </div>
              <button class="login-button" id="login-btn">开始实验</button>
              <div id="login-status" style="margin-top: 15px;"></div>
            </div>
          `;

          // 监听被试ID变化，更新天数显示
          document.getElementById('subject-id').addEventListener('change', function() {
            const subjectId = this.value;
            if (subjectId) {
              const storedDay = localStorage.getItem(`day_${subjectId}`);
              const currentDay = storedDay ? parseInt(storedDay) + 1 : 1;

              const dayInfoEl = document.getElementById('day-info');
              dayInfoEl.innerHTML = `
                <div class="form-group">
                  <label for="day-input">实验天数</label>
                  <input type="number" id="day-input" min="1" max="30" value="${currentDay}">
                  <p class="adjustment-hint">系统读取天数可能有误，可根据实验情况调整</p>
                </div>
              `;

              // 尝试获取存储的用户信息并自动填充
              const userData = localStorage.getItem(`user_${subjectId}`);
              if (userData) {
                try {
                  const { gender, age } = JSON.parse(userData);
                  document.getElementById('gender').value = gender;
                  document.getElementById('age').value = age;
                } catch (e) {
                  console.error('解析用户信息失败', e);
                }
              }
            }
          });

          // 登录按钮事件
          document.getElementById('login-btn').addEventListener('click', function() {
            const subjectId = document.getElementById('subject-id').value;
            const gender = document.getElementById('gender').value;
            const age = document.getElementById('age').value;
            const dayInput = document.getElementById('day-input');
            const statusEl = document.getElementById('login-status');

            if (!subjectId) {
              statusEl.innerHTML = '<p style="color: #e74c3c;">请选择被试ID</p>';
              return;
            }
            if (!gender) {
              statusEl.innerHTML = '<p style="color: #e74c3c;">请选择性别</p>';
              return;
            }
            if (!age) {
              statusEl.innerHTML = '<p style="color: #e74c3c;">请输入年龄</p>';
              return;
            }
            if (!dayInput) {
              statusEl.innerHTML = '<p style="color: #e74c3c;">请输入实验天数</p>';
              return;
            }

            // 获取用户输入的天数
            const day = parseInt(dayInput.value);

            // 保存用户信息
            userInfo = {
              subjectId,
              day,
              gender,
              age: parseInt(age)
            };

            // 存储用户信息（性别和年龄）
            localStorage.setItem(`user_${subjectId}`, JSON.stringify({ gender, age }));

            // 显示成功信息
            statusEl.innerHTML = '<p style="color: #27ae60;">验证通过，正在进入实验...</p>';

            // 继续实验流程
            setTimeout(() => {
              jsPsych.finishTrial();
            }, 1000);
          });
        });

        // 填写问卷按钮
        document.getElementById('start-questionnaire').addEventListener('click', function() {
          // 显示问卷用户选择表单
          document.querySelector('.jspsych-content').innerHTML = `
            <div class="login-container">
              <h2>填写周反思总结</h2>
              <div class="form-group">
                <label for="questionnaire-subject-id">被试ID</label>
                <select id="questionnaire-subject-id">
                  <option value="">请选择被试ID</option>
                  ${Array.from({length: 21}, (_, i) =>
                    `<option value="EYE-${(i+1).toString().padStart(3, '0')}">EYE-${(i+1).toString().padStart(3, '0')}</option>`
                  ).join('')}
                </select>
              </div>
              <div id="questionnaire-day-info"></div>
              <button class="login-button" id="questionnaire-login-btn">开始填写</button>
              <div id="questionnaire-status" style="margin-top: 15px;"></div>
            </div>
          `;

          // 监听被试ID变化，更新天数显示
          document.getElementById('questionnaire-subject-id').addEventListener('change', function() {
            const subjectId = this.value;
            if (subjectId) {
              const storedDay = localStorage.getItem(`day_${subjectId}`);
              const currentDay = storedDay ? parseInt(storedDay) : 0;

              // 获取问卷填写次数
              const storedWeekCount = localStorage.getItem(`weekCount_${subjectId}`);
              const weekCount = storedWeekCount ? parseInt(storedWeekCount) : 1;

              const dayInfoEl = document.getElementById('questionnaire-day-info');
              dayInfoEl.innerHTML = `
                <div class="day-display">您已完成 <span>${currentDay}</span> 天实验</div>
                <div class="form-group">
                  <label for="week-input">周反思总结次数</label>
                  <input type="number" id="week-input" min="1" max="10" value="${weekCount}">
                  <p class="adjustment-hint">系统读取次数可能有误，可根据实验情况调整</p>
                </div>
              `;

              // 设置用户信息（包含问卷周次）
              userInfo = {
                subjectId: subjectId,
                day: currentDay,
                weekCount: weekCount  // 存储当前周次
              };
            }
          });

          // 问卷登录按钮事件
          document.getElementById('questionnaire-login-btn').addEventListener('click', function() {
            const subjectId = document.getElementById('questionnaire-subject-id').value;
            const weekInput = document.getElementById('week-input');
            const statusEl = document.getElementById('questionnaire-status');

            if (!subjectId) {
              statusEl.innerHTML = '<p style="color: #e74c3c;">请选择被试ID</p>';
              return;
            }
            if (!weekInput) {
              statusEl.innerHTML = '<p style="color: #e74c3c;">请输入周反思总结次数</p>';
              return;
            }

            // 从localStorage获取当前天数
            const storedDay = localStorage.getItem(`day_${subjectId}`);
            const day = storedDay ? parseInt(storedDay) : 0;

            // 获取用户输入的周次
            const weekCount = parseInt(weekInput.value);

            // 设置用户信息
            userInfo = {
              subjectId,
              day,
              weekCount
            };

            // 更新问卷周次记录，这样下次填写问卷时会在当前周次基础上加1
            localStorage.setItem(`weekCount_${subjectId}`, weekCount.toString());

            // 显示成功信息
            statusEl.innerHTML = '<p style="color: #27ae60;">准备就绪，正在加载问卷...</p>';

            // 加载问卷
            setTimeout(() => {
              // 初始化问卷
              initQuestionnaire();
              // 显示问卷
              document.getElementById('questionnaire-modal').style.display = 'flex';
            }, 1000);
          });
        });
      }
    };

    const timeline = [];

    // 添加登录页面
    timeline.push(loginScreen);

    // 显示欢迎信息
    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        if (!userInfo) {
          return `
            <div class="centered-text">
              <p>欢迎参与实验</p>
              <p>按任意键继续</p>
            </div>
          `;
        }
        return `
          <div class="centered-text">
            <p>欢迎您参与第 ${userInfo.day} 天的实验</p>
            <p>按任意键继续</p>
          </div>
        `;
      }
    });

    /* 预加载资源 */
    const imagesToPreload = [...lowCalorieImages, ...highCalorieImages];
    const audioToPreload = musicFiles;
    const preload = {
      type: jsPsychPreload,
      images: imagesToPreload,
      audio: audioToPreload,
      message: '<div class="centered-text"><p>正在加载资源，请稍候…</p></div>'
    };
    timeline.push(preload);

    /* ==== 校准相关的各个步骤 ==== */
    const camera_instructions = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <div class="centered-text">
          <p>为了进行眼动追踪，我们需要访问您的摄像头。</p>
          <p>您将在下一屏幕收到权限请求。</p>
          <p class="warning">请务必点击"允许"，否则眼动追踪功能将无法工作。</p>
          <p>摄像头仅用于分析您的眼部运动，不会保存任何视频数据。</p>
        </div>
      `,
      choices: ['明白了'],
      on_load: async function() {
        // 提前检测权限
        const cameraStatus = await checkCameraPermission();

        // 如果权限有问题，显示错误提示
        if (!cameraStatus.hasPermission || !cameraStatus.isSecure || !cameraStatus.hasMediaDevices) {
          showPermissionError(cameraStatus);

          // 保存继续实验的函数
          window.resumeExperiment = () => {
            jsPsych.finishTrial();
          };

          // 暂停实验直到用户操作
          return false;
        }
      }
    };
    timeline.push(camera_instructions);

    // 初始化摄像头（显示画面）
    const init_camera = {
      type: jsPsychWebgazerInitCamera,
      on_error: function() {
        cameraPermissionDenied = true;
        updateInitStatus('webgazer', '初始化失败', true);
      },
      on_load: function() {
        updateInitStatus('webgazer', '初始化中...');
      },
      on_finish: function() {
        if (!cameraPermissionDenied) {
          updateInitStatus('webgazer', '已初始化');
          webgazerInitialized = true;
        }
      }
    };
    timeline.push(init_camera);

    // 添加权限检查点
    timeline.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: '',
      choices: [],
      trial_duration: 100,
      on_load: function() {
        // 如果权限被拒绝，跳过眼动相关步骤
        if (cameraPermissionDenied) {
          // 直接跳转到实验说明
          jsPsych.endCurrentTimeline();

          // 显示警告
          const warningHTML = `
            <div class="centered-text">
              <p class="warning">警告：摄像头权限未授予</p>
              <p>眼动追踪功能已被禁用，实验将继续进行但不会记录眼动数据。</p>
              <p>按任意键继续实验。</p>
            </div>
          `;

          const warningTrial = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: warningHTML
          };

          jsPsych.addNodeToEndOfTimeline(warningTrial);
        }
      }
    });

    const calibration_instructions = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <div class="centered-text">
          <p>现在将进行眼动校准，以便软件使用您的眼部图像预测您的注视位置。</p>
          <p>您将看到一系列圆点出现在屏幕上。请注视每个圆点并点击它。</p>
        </div>
      `,
      choices: ['明白了']
    };
    timeline.push(calibration_instructions);

    const calibration = {
      type: jsPsychWebgazerCalibrate,
      calibration_points: [
        [25, 25], [75, 25], [50, 50], [25, 75], [75, 75]
      ],
      repetitions_per_point: 2,
      randomize_calibration_order: true
    };
    timeline.push(calibration);

    const validation_instructions = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <div class="centered-text">
          <p>现在我们将测量校准的准确性。</p>
          <p>请注视屏幕上出现的每个圆点。</p>
          <p style="font-weight: bold;">这次您不需要点击圆点。</p>
        </div>
      `,
      choices: ['明白了'],
      post_trial_gap: 1000
    };
    timeline.push(validation_instructions);

    const validation = {
      type: jsPsychWebgazerValidate,
      validation_points: [
        [25, 25], [75, 25], [50, 50], [25, 75], [75, 75]
      ],
      roi_radius: 200,
      time_to_saccade: 1000,
      validation_duration: 2000,
      data: { task: 'validate' }
    };
    timeline.push(validation);

    const recalibrate_instructions = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <div class="centered-text">
          <p>校准的准确性低于预期水平。</p>
          <p>让我们再尝试校准一次。</p>
          <p>在下一屏幕，请注视圆点并点击它们。</p>
        </div>
      `,
      choices: ['好的']
    };
    const recalibrate = {
      timeline: [recalibrate_instructions, calibration, validation_instructions, validation],
      conditional_function: function() {
        const val_data = jsPsych.data.get().filter({ task: 'validate' }).values()[0];
        return val_data && val_data.percent_in_roi && val_data.percent_in_roi.some(x => x < 50);
      },
      data: { phase: 'recalibration' }
    };
    timeline.push(recalibrate);

    const calibration_done = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <div class="centered-text">
          <p>太好了，校准已完成！</p>
          <p>接下来将开始实验，请注视屏幕中央的十字，然后开始注视食物图片。</p>
        </div>
      `,
      choices: ['继续']
    };
    timeline.push(calibration_done);

    /* ==== 欢迎页 和 实验说明 ==== */
    const welcome = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div class="centered-text">
          <p>欢迎参加进食障碍眼动干预实验。按任意键继续。</p>
        </div>
      `
    };
    timeline.push(welcome);

    const instructions = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        return `
          <div class="centered-text">
            <p>在实验中，屏幕上将呈现4张食物图片，包含2张低热量和2张高热量食物。</p>
            <p>当您注视低热量食物时，将播放愉悦的音乐。</p>
            <p>当您注视高热量食物时，音乐将停止播放。</p>
            <p>实验共有 30 个试次，每个试次持续 8 秒，试次间休息 2 秒。</p>
            <p>请按任意键开始实验。</p>
          </div>
        `;
      },
      post_trial_gap: 2000
    };
    timeline.push(instructions);

    /* ==== 构建 30 个试次 ==== */
    const trial_count = 30; // 30个试次
    const trials = [];
    const centralFixation = document.getElementById('central-fixation');
    const gazePoint = document.getElementById('gaze-point');

    // 存储眼动数据
    const gazeData = [];

    for (let i = 0; i < trial_count; i++) {
      const lowCount = 2;
      const highCount = 2;

      // 提取图片ID（从文件名中提取001-020）
      const lowImageIdxs = jsPsych.randomization.sampleWithoutReplacement(
        Array.from({length: lowCalorieImages.length}, (_, k) => k),
        lowCount
      );
      const highImageIdxs = jsPsych.randomization.sampleWithoutReplacement(
        Array.from({length: highCalorieImages.length}, (_, k) => k),
        highCount
      );

      // 存储图片完整信息（包括ID）
      const lowImages = lowImageIdxs.map(idx => {
        const src = lowCalorieImages[idx];
        const id = src.split('/').pop().split('.')[0]; // 提取图片ID（如001）
        return { src, type: 'low', id };
      });

      const highImages = highImageIdxs.map(idx => {
        const src = highCalorieImages[idx];
        const id = src.split('/').pop().split('.')[0]; // 提取图片ID（如001）
        return { src, type: 'high', id };
      });

      let allImages = [
        ...lowImages,
        ...highImages
      ];
      allImages = jsPsych.randomization.shuffle(allImages);

      // 为当前试次初始化眼动数据存储
      gazeData[i] = [];

      // 注视点试次
      trials.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '',
        choices: "NO_KEYS",
        trial_duration: jsPsych.randomization.sampleWithoutReplacement([800, 1000, 1200], 1)[0],
        data: {
          task: 'fixation',
          trial_index: i + 1,
          day: userInfo ? userInfo.day : 1
        },
        on_start: function() {
          centralFixation.style.display = 'block';
        },
        on_finish: function() {
          centralFixation.style.display = 'none';
        }
      });

      // 图片展示试次
      const trial = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
          let imagesHtml = '';
          allImages.forEach((img, index) => {
            imagesHtml += `
              <div class="food-item" id="food-${index}" data-type="${img.type}" data-id="${img.id}">
                <img src="${img.src}" />
              </div>
            `;
          });

          return `
            <div class="food-container">
              ${imagesHtml}
            </div>
          `;
        },
        trial_duration: 8000,
        choices: "NO_KEYS",
        data: {
          task: 'test',
          trial_index: i + 1,
          day: userInfo ? userInfo.day : 1,
          subjectId: userInfo ? userInfo.subjectId : "UNKNOWN",
          low_images: lowImages.map(img => ({src: img.src, id: img.id})),
          high_images: highImages.map(img => ({src: img.src, id: img.id})),
          image_layout: allImages.map(img => ({ type: img.type, id: img.id })) // 修改：存储图片布局（包含类型和ID）
        },
        extensions: [
          {
            type: jsPsychExtensionWebgazer,
            params: { targets: ['#food-0', '#food-1', '#food-2', '#food-3'] }
          }
        ],
        on_start: function(trial) {
          const lowSelectors = [];
          for (let j = 0; j < 4; j++) {
            if (allImages[j].type === 'low') {
              lowSelectors.push(`#food-${j}`);
            }
          }

          const musicIndicator = document.getElementById('music-indicator');
          const audio = window.globalAudio;

          // 记录试次开始时间
          const trialStartTime = Date.now();

          let isGazingLow = false;
          let pauseTimeout = null;
          let lastPosition = null;
          let lastTimestamp = null;

          // 存储每个图片的位置信息（用于判断注视点）
          const imageRects = [];

          // 获取页面滚动偏移量
          const scrollX = window.pageXOffset;
          const scrollY = window.pageYOffset;

          // 等待图片加载完成后再获取位置信息
          setTimeout(() => {
            for (let j = 0; j < 4; j++) {
              const imgEl = document.getElementById(`food-${j}`);
              if (imgEl) {
                const rect = imgEl.getBoundingClientRect();
                // 将视口坐标转换为文档坐标
                imageRects.push({
                  id: allImages[j].id,
                  type: allImages[j].type,
                  left: rect.left + scrollX,
                  top: rect.top + scrollY,
                  right: rect.right + scrollX,
                  bottom: rect.bottom + scrollY
                });
              }
            }
            // 调试输出
            console.log('Image positions:', imageRects);
          }, 100); // 延迟100ms确保图片已渲染

          // 如果摄像头权限被拒绝，跳过眼动跟踪
          if (cameraPermissionDenied) {
            // 显示静态信息
            musicIndicator.textContent = "眼动追踪已禁用";
            musicIndicator.style.display = 'block';
            musicIndicator.style.background = 'linear-gradient(90deg, #e67e22, #d35400)';
            return;
          }

          const webgazerCallback = function() {
            if (typeof webgazer === 'undefined') return;

            webgazer.getCurrentPrediction().then(function(pred) {
              if (!pred) return;
              const x = pred.x, y = pred.y;
              const currentTimestamp = Date.now();

              // 计算持续时间
              let duration = 0;
              if (lastTimestamp) {
                duration = currentTimestamp - lastTimestamp;
              }

              // 确定当前点所在的图片（如果有）
              let currentImageInfo = null;
              for (const rect of imageRects) {
                // 添加5px容差范围
                if (x >= rect.left - 5 && x <= rect.right + 5 &&
                    y >= rect.top - 5 && y <= rect.bottom + 5) {
                  currentImageInfo = {
                    type: rect.type,
                    id: rect.id
                  };
                  break;
                }
              }

              // 记录眼动数据点 - 添加图片信息
              const timestamp = currentTimestamp - trialStartTime;
              gazeData[i].push({
                x,
                y,
                timestamp,
                duration,
                imageInfo: currentImageInfo  // 添加图片信息
              });

              lastPosition = {x, y};
              lastTimestamp = currentTimestamp;

              let inLow = false;
              lowSelectors.forEach(selector => {
                const lowEl = document.querySelector(selector);
                if (lowEl) {
                  const rect = lowEl.getBoundingClientRect();
                  // 转换为文档坐标
                  const docLeft = rect.left + scrollX;
                  const docTop = rect.top + scrollY;
                  const docRight = rect.right + scrollX;
                  const docBottom = rect.bottom + scrollY;

                  // 添加容差
                  if (x >= docLeft - 5 && x <= docRight + 5 &&
                      y >= docTop - 5 && y <= docBottom + 5) {
                    inLow = true;
                  }
                }
              });

              if (inLow) {
                if (!isGazingLow) {
                  isGazingLow = true;
                  if (pauseTimeout) {
                    clearTimeout(pauseTimeout);
                    pauseTimeout = null;
                  }
                  if (audio.paused) {
                    audio.play().catch(e => console.log('播放失败', e));
                    musicIndicator.style.display = 'block';
                    musicIndicator.style.background = 'linear-gradient(90deg, #1abc9c, #16a085)';
                    musicIndicator.textContent = "音乐播放中";
                  }
                }
              } else {
                if (isGazingLow) {
                  isGazingLow = false;

                  if (!pauseTimeout) {
                    pauseTimeout = setTimeout(() => {
                      if (!isGazingLow && !audio.paused) {
                        audio.pause();
                        musicIndicator.textContent = "音乐已暂停";
                        musicIndicator.style.background = 'linear-gradient(90deg, #e74c3c, #c0392b)';
                      }
                      pauseTimeout = null;
                    }, 500);
                  }
                }
              }
            }).catch(e => console.log('获取眼动预测失败:', e));
          };

          // 修改为30Hz采样频率（每33毫秒采样一次）
          trial.interval = setInterval(webgazerCallback, 33);
        },
        on_finish: function() {
          if (this.interval) {
            clearInterval(this.interval);
          }
          gazePoint.style.display = 'none';
        }
      };

      trials.push(trial);

      // 试次间休息
      if (i < trial_count - 1) {
        trials.push({
          type: jsPsychHtmlKeyboardResponse,
          stimulus: '',
          choices: "NO_KEYS",
          trial_duration: 2000,
          data: {
            task: 'rest',
            trial_index: i + 1,
            day: userInfo ? userInfo.day : 1
          }
        });
      }
    }

    timeline.push({
      timeline: trials,
      randomize_order: false
    });

    /* ==== 数据处理和GitHub上传 ==== */
    const dataProcessingTrial = {
      type: jsPsychHtmlButtonResponse,
      stimulus: function() {
        return `
          <div class="centered-text">
            <p>实验完成！正在处理数据...</p>
            <div class="status-message status-loading" id="status-message">
              数据计算中，请稍候...
            </div>
          </div>
        `;
      },
      choices: [],
      on_load: async function() {
        try {
          const statusMessage = document.getElementById('status-message');

          // 如果摄像头权限被拒绝，跳过GitHub上传
          if (cameraPermissionDenied) {
            statusMessage.className = "status-message status-error";
            statusMessage.textContent = "眼动数据未记录（摄像头权限被拒绝）";

            // 显示仅包含行为数据的报告
            const content = `
              <div class="centered-text">
                <h2>实验完成</h2>
                <p class="warning">眼动追踪功能被禁用（摄像头权限未授予）</p>
                <p>仅行为数据已被记录。</p>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 30px;">
                  <button class="exit-button" id="exit-btn">退出实验</button>
                </div>
              </div>
            `;

            document.querySelector('.jspsych-content').innerHTML = content;
            document.getElementById('exit-btn').addEventListener('click', () => {
              location.reload();
            });

            return;
          }

          // 上传数据的核心函数
          const uploadData = async () => {
            // 1. 创建或获取GitHub Issue（每个被试只创建一个）
            statusMessage.textContent = "连接GitHub仓库...";
            const issue = await getOrCreateIssue();

            // 2. 生成GitHub评论内容（只包含数据点个数和实验时间）
            statusMessage.textContent = "生成数据报告...";
            const commentBody = generateGitHubComment(gazeData);

            // 3. 添加评论到Issue（每天的数据作为一条评论）
            statusMessage.textContent = "上传数据到GitHub Issues...";
            await addIssueComment(issue.number, commentBody);

            // 4. 生成CSV数据并上传到仓库的data目录
            statusMessage.textContent = "生成CSV数据文件...";
            const csvContent = generateCSVData(gazeData);

            // 使用更安全的文件名格式：subjectId_day.csv
            const fileName = `${userInfo.subjectId}_day${userInfo.day}.csv`;

            statusMessage.textContent = "上传CSV文件到GitHub的data目录...";
            await uploadCSVToGitHub(csvContent, fileName);

            // 5. 更新天数记录（只有成功完成实验才更新天数）
            localStorage.setItem(`day_${userInfo.subjectId}`, userInfo.day.toString());

            // 6. 更新状态显示
            statusMessage.className = "status-message status-success";
            statusMessage.textContent = "数据上传成功！实验天数已更新！";

            // 7. 显示数据报告和操作按钮
            const content = `
              <div class="centered-text">
                <h2>第 ${userInfo.day} 天实验完成</h2>
                ${userInfo.day === 30 ? '<p style="color:#27ae60;font-weight:bold;font-size:1.8rem;margin:20px 0;">恭喜您已成功完成30天眼动干预实验！</p>' : ''}
                <p>详细眼动数据已成功上传至GitHub仓库的data目录</p>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 30px;">
                  <button class="copy-button" id="copy-btn">复制报告摘要</button>
                  <button class="github-button" id="github-btn">查看GitHub记录</button>
                  <button class="save-button" id="save-btn">保存数据到本地</button>
                  <button class="exit-button" id="exit-btn">退出实验</button>
                </div>
              </div>
            `;

            document.querySelector('.jspsych-content').innerHTML = content;

            // 添加按钮事件
            document.getElementById('copy-btn').addEventListener('click', function() {
              // 计算数据点总数
              const dataPoints = gazeData.reduce((acc, trial) => acc + trial.length, 0);
              const summary = `被试ID: ${userInfo.subjectId}\n实验天数: ${userInfo.day}\n数据点数量: ${dataPoints}\n文件位置: data/${fileName}`;
              navigator.clipboard.writeText(summary)
                .then(() => alert('报告摘要已复制到剪贴板'))
                .catch(err => console.error('复制失败:', err));
            });

            // GitHub查看权限验证
            document.getElementById('github-btn').addEventListener('click', function() {
              const authModal = document.getElementById('auth-modal');
              const authError = document.getElementById('auth-error');
              const authCode = document.getElementById('auth-code');

              // 重置验证状态
              authError.style.display = 'none';
              authCode.value = '';

              // 显示验证弹窗
              authModal.style.display = 'flex';

              // 确认按钮事件
              document.getElementById('auth-confirm').onclick = function() {
                if (authCode.value.toLowerCase() === 'eye') {
                  window.open(issue.html_url, '_blank');
                  authModal.style.display = 'none';
                } else {
                  authError.style.display = 'block';
                }
              };

              // 返回按钮事件
              document.getElementById('auth-cancel').onclick = function() {
                authModal.style.display = 'none';
              };
            });

            // 保存数据到本地按钮
            document.getElementById('save-btn').addEventListener('click', function() {
              // 生成CSV数据
              const csvContent = generateCSVData(gazeData);
              // 保存到本地
              saveCSVToLocal(csvContent);
            });

            // 退出实验按钮 - 改为刷新页面
            document.getElementById('exit-btn').addEventListener('click', function() {
              location.reload(); // 刷新页面回到登录界面
            });
          };

          // 执行上传
          await uploadData();

        } catch (error) {
          const statusMessage = document.getElementById('status-message');
          statusMessage.className = "status-message status-error";
          statusMessage.textContent = `数据处理失败: ${error.message}`;
          console.error('完整错误信息:', error);

          // 生成CSV数据
          const csvContent = generateCSVData(gazeData);

          // 显示错误恢复选项
          document.querySelector('.jspsych-content').innerHTML += `
            <div class="error-panel">
              <h4>数据上传失败处理方案</h4>
              <p>系统无法自动上传数据到服务器，请选择以下操作：</p>
              <ul>
                <li>检查您的网络连接后重试</li>
                <li>保存数据到本地并稍后提交给实验负责人</li>
                <li>退出实验并重新开始</li>
              </ul>
            </div>

            <div style="margin-top: 20px; text-align: center;">
              <button class="login-button" id="retry-btn">重试上传</button>
              <button class="github-button" id="save-btn">保存数据到本地</button>
              <button class="exit-button" id="exit-btn">退出实验</button>
            </div>
          `;

          // 重试上传按钮
          document.getElementById('retry-btn').addEventListener('click', async () => {
            const statusMessage = document.getElementById('status-message');
            statusMessage.className = "status-message status-loading";
            statusMessage.textContent = "正在重试上传数据...";

            try {
              // 重新执行上传逻辑
              await uploadData();
            } catch (retryError) {
              statusMessage.className = "status-message status-error";
              statusMessage.textContent = `重试失败: ${retryError.message}`;
              console.error('重试错误信息:', retryError);
            }
          });

          // 保存数据按钮
          document.getElementById('save-btn').addEventListener('click', function() {
            // 创建CSV格式的眼动数据
            let csvContent = generateCSVData(gazeData);

            // 保存到本地
            saveCSVToLocal(csvContent);

            // 更新实验天数（保存到本地也视为完成实验）
            localStorage.setItem(`day_${userInfo.subjectId}`, userInfo.day.toString());

            // 提示用户
            alert('数据已保存到本地，实验天数已更新。');
          });

          // 退出实验按钮 - 改为刷新页面
          document.getElementById('exit-btn').addEventListener('click', function() {
            location.reload(); // 刷新页面回到登录界面
          });
        }
      }
    };

    timeline.push(dataProcessingTrial);

    /* ==== 运行实验 ==== */
    jsPsych.run(timeline);

    /* ==== 问卷提交处理 ==== */
    document.addEventListener('click', function(e) {
      if (e.target.id === 'submit-questionnaire') {
        const errorElement = document.getElementById('questionnaire-error');
        const successElement = document.getElementById('questionnaire-success');

        // 验证问卷是否完整
        if (!validateQuestionnaire()) {
          errorElement.style.display = 'block';
          successElement.style.display = 'none';
          setTimeout(() => {
            errorElement.style.display = 'none';
          }, 3000);
          return;
        }

        // 收集问卷数据
        const questionnaireData = collectQuestionnaireData();

        // 生成Markdown格式的评论
        const markdownContent = generateQuestionnaireMarkdown(questionnaireData);

        // 显示提交中状态
        const submitButton = e.target;
        submitButton.textContent = '提交中...';
        submitButton.disabled = true;

        // 隐藏之前的错误信息
        errorElement.style.display = 'none';
        successElement.style.display = 'none';

        // 提交问卷到GitHub
        getOrCreateIssue()
          .then(issue => {
            return addIssueComment(issue.number, markdownContent);
          })
          .then(() => {
            // 提交成功，更新按钮
            const buttonsContainer = document.getElementById('submit-buttons');
            buttonsContainer.innerHTML = `
              <button class="save-button" id="save-questionnaire">保存问卷结果</button>
            `;

            // 显示成功提示
            successElement.style.display = 'block';

            // 更新周次计数器
            const newWeekCount = userInfo.weekCount + 1;
            localStorage.setItem(`weekCount_${userInfo.subjectId}`, newWeekCount);
            userInfo.weekCount = newWeekCount;

            // 保存问卷结果按钮事件
            document.getElementById('save-questionnaire').addEventListener('click', function() {
              saveQuestionnaireToWord(questionnaireData);
            });
          })
          .catch(error => {
            console.error('问卷提交失败:', error);

            // 提交失败，显示错误信息
            errorElement.style.display = 'block';
            errorElement.textContent = `提交失败: ${error.message}`;
            successElement.style.display = 'none';

            // 更新按钮 - 添加本地保存按钮
            const buttonsContainer = document.getElementById('submit-buttons');
            buttonsContainer.innerHTML = `
              <button class="save-button" id="save-questionnaire">保存问卷到本地</button>
            `;

            // 保存问卷结果按钮事件
            document.getElementById('save-questionnaire').addEventListener('click', function() {
              saveQuestionnaireToWord(questionnaireData);
            });

            // 恢复提交按钮状态
            submitButton.textContent = '提交问卷';
            submitButton.disabled = false;
          });
      }
    });
  </script>
</body>
</html>
