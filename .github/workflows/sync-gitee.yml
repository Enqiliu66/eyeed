name: 自动同步到Gitee & 部署Pages
on:
  push:
    branches: [main]  # 代码推送到main分支时触发
  schedule:
    - cron: '0 8 * * *'  # 每天8点定时同步（可选）

jobs:
  sync-to-gitee:
    runs-on: ubuntu-latest
    steps:
      - name: 检出完整代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 拉取所有历史记录，避免分支同步问题

      - name: 🔑 配置Gitee SSH同步（推荐）
        run: |
          # 1. 生成SSH密钥对（已存在则跳过）
          ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa -C "gitee-actions@${{ github.repository }}"
          
          # 2. 配置Git用户（Gitee提交记录显示）
          git config --global user.name "Gitee Sync Bot"
          git config --global user.email "actions@${{ github.repository_owner }}.github.io"
          
          # 3. 添加Gitee SSH公钥（需提前在Gitee账户配置）
          echo "-----BEGIN PUBLIC KEY-----
${{ secrets.GITEE_SSH_PUB_KEY }}
-----END PUBLIC KEY-----" >> ~/.ssh/authorized_keys
          
          # 4. 验证远程仓库
          git remote add gitee git@gitee.com:${{ secrets.GITEE_USER }}/${{ github.repository_name }}.git
          git remote -v
          
          # 5. 强制同步main分支（覆盖Gitee端修改）
          git push -f gitee main:main
        env:
          GIT_SSH_COMMAND: 'ssh -o StrictHostKeyChecking=no'  # 信任Gitee主机

  deploy-gitee-pages:
    needs: sync-to-gitee  # 依赖同步完成
    runs-on: ubuntu-latest
    steps:
      - name: 🚀 部署Gitee Pages（官方推荐方式）
        uses: yanglbme/gitee-pages-action@v1.4.2  # 使用稳定版本标签
        with:
          # 🔍 必需参数（从Secrets获取，避免硬编码）
          gitee-username: ${{ secrets.GITEE_USER }}  # Gitee用户名
          gitee-repo: ${{ secrets.GITEE_USER }}/${{ github.repository_name }}  # 仓库路径
          gitee-token: ${{ secrets.GITEE_TOKEN }}  # Gitee私人令牌（更安全）
          
          # 🔧 可选参数（按需配置）
          branch: main  # 部署的分支（默认main）
          directory: .  # 部署目录（默认仓库根目录）
          https: true  # 强制HTTPS
          commit-message: "自动部署Pages [ci skip]"  # 提交备注
