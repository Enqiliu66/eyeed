name: è‡ªåŠ¨åŒæ­¥åˆ°Gitee & éƒ¨ç½²Pages
on:
  push:
    branches: [main]  # ä»£ç æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  schedule:
    - cron: '0 8 * * *'  # æ¯å¤©8ç‚¹å®šæ—¶åŒæ­¥ï¼ˆå¯é€‰ï¼‰

jobs:
  sync-to-gitee:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºå®Œæ•´ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–æ‰€æœ‰å†å²è®°å½•ï¼Œé¿å…åˆ†æ”¯åŒæ­¥é—®é¢˜

      - name: ğŸ”‘ é…ç½®Gitee SSHåŒæ­¥ï¼ˆæ¨èï¼‰
        run: |
          # 1. ç”ŸæˆSSHå¯†é’¥å¯¹ï¼ˆå·²å­˜åœ¨åˆ™è·³è¿‡ï¼‰
          ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa -C "gitee-actions@${{ github.repository }}"
          
          # 2. é…ç½®Gitç”¨æˆ·ï¼ˆGiteeæäº¤è®°å½•æ˜¾ç¤ºï¼‰
          git config --global user.name "Gitee Sync Bot"
          git config --global user.email "actions@${{ github.repository_owner }}.github.io"
          
          # 3. æ·»åŠ Gitee SSHå…¬é’¥ï¼ˆéœ€æå‰åœ¨Giteeè´¦æˆ·é…ç½®ï¼‰
          echo "-----BEGIN PUBLIC KEY-----
${{ secrets.GITEE_SSH_PUB_KEY }}
-----END PUBLIC KEY-----" >> ~/.ssh/authorized_keys
          
          # 4. éªŒè¯è¿œç¨‹ä»“åº“
          git remote add gitee git@gitee.com:${{ secrets.GITEE_USER }}/${{ github.repository_name }}.git
          git remote -v
          
          # 5. å¼ºåˆ¶åŒæ­¥mainåˆ†æ”¯ï¼ˆè¦†ç›–Giteeç«¯ä¿®æ”¹ï¼‰
          git push -f gitee main:main
        env:
          GIT_SSH_COMMAND: 'ssh -o StrictHostKeyChecking=no'  # ä¿¡ä»»Giteeä¸»æœº

  deploy-gitee-pages:
    needs: sync-to-gitee  # ä¾èµ–åŒæ­¥å®Œæˆ
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ éƒ¨ç½²Gitee Pagesï¼ˆå®˜æ–¹æ¨èæ–¹å¼ï¼‰
        uses: yanglbme/gitee-pages-action@v1.4.2  # ä½¿ç”¨ç¨³å®šç‰ˆæœ¬æ ‡ç­¾
        with:
          # ğŸ” å¿…éœ€å‚æ•°ï¼ˆä»Secretsè·å–ï¼Œé¿å…ç¡¬ç¼–ç ï¼‰
          gitee-username: ${{ secrets.GITEE_USER }}  # Giteeç”¨æˆ·å
          gitee-repo: ${{ secrets.GITEE_USER }}/${{ github.repository_name }}  # ä»“åº“è·¯å¾„
          gitee-token: ${{ secrets.GITEE_TOKEN }}  # Giteeç§äººä»¤ç‰Œï¼ˆæ›´å®‰å…¨ï¼‰
          
          # ğŸ”§ å¯é€‰å‚æ•°ï¼ˆæŒ‰éœ€é…ç½®ï¼‰
          branch: main  # éƒ¨ç½²çš„åˆ†æ”¯ï¼ˆé»˜è®¤mainï¼‰
          directory: .  # éƒ¨ç½²ç›®å½•ï¼ˆé»˜è®¤ä»“åº“æ ¹ç›®å½•ï¼‰
          https: true  # å¼ºåˆ¶HTTPS
          commit-message: "è‡ªåŠ¨éƒ¨ç½²Pages [ci skip]"  # æäº¤å¤‡æ³¨
